# NexDynIPC 功能融合实施路线图

## 文档概述

本文档详细规划 NexDynIPC 项目五大功能（自动微分、区间算术、BVH加速、CCD、自适应刚度、摩擦势能）的引入建议和实施路线图。

---

## 1. 引入建议

### 1.1 推荐引入顺序

根据功能之间的依赖关系和重要性，建议按以下顺序引入：

```
┌─────────────────────────────────────────────────────────────┐
│  Phase 0: 基础设施（无依赖）                                  │
│  ├── 自动微分系统（可选，暂不使用）                           │
│  └── 区间算术（CCD依赖）                                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: 几何加速（独立模块）                                │
│  └── BVH 加速结构                                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: 碰撞核心（依赖Phase 0+1）                          │
│  ├── CCD 连续碰撞检测                                        │
│  └── 自适应障碍刚度                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: 物理增强（依赖Phase 2）                            │
│  └── 摩擦势能模型                                            │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 各功能引入建议

| 功能 | 引入建议 | 理由 |
|------|----------|------|
| **自动微分** | 暂缓引入，仅移植代码 | 当前手动推导足够，复杂场景再启用 |
| **区间算术** | 优先引入 | CCD 的基础依赖 |
| **BVH** | 优先引入 | 独立模块，立即提升性能 |
| **CCD** | 核心引入 | IPC 无穿透保证的关键 |
| **自适应刚度** | 核心引入 | 提高数值稳定性 |
| **摩擦势能** | 后续引入 | 依赖碰撞检测完成 |

### 1.3 功能依赖关系图

```
                    ┌──────────────┐
                    │  自动微分     │ (可选)
                    │  AutoDiff    │
                    └──────────────┘
                           │
                           ↓
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   区间算术    │───→│     CCD      │←───│    BVH       │
│   Interval   │    │ 连续碰撞检测  │    │  加速结构    │
└──────────────┘    └──────────────┘    └──────────────┘
                           │
                           ↓
                    ┌──────────────┐
                    │  自适应刚度   │
                    │ AdaptiveBar  │
                    └──────────────┘
                           │
                           ↓
                    ┌──────────────┐
                    │  摩擦势能     │
                    │  Friction    │
                    └──────────────┘
```

---

## 2. 总体规划

### 2.1 时间规划（12周）

```
Week 1-2   │ Week 3-4   │ Week 5-6   │ Week 7-8   │ Week 9-10  │ Week 11-12
───────────┼────────────┼────────────┼────────────┼────────────┼────────────
 基础设施   │   BVH      │    CCD     │  自适应    │   摩擦     │  集成测试
           │   加速     │   核心     │   刚度     │   势能     │
```

### 2.2 里程碑规划

| 里程碑 | 时间点 | 验收标准 |
|--------|--------|----------|
| M1: 基础设施完成 | Week 2 | 区间算术、自动微分单元测试通过 |
| M2: BVH 可用 | Week 4 | BVH 性能优于暴力检测 10x |
| M3: CCD 无穿透 | Week 6 | 快速运动场景无穿透 |
| M4: 自适应刚度稳定 | Week 8 | 堆叠场景稳定收敛 |
| M5: 摩擦正确 | Week 10 | 斜面滑块摩擦力正确 |
| M6: 全功能集成 | Week 12 | 所有测试场景通过 |

---

## 3. 详细实施计划

### 3.1 Week 1-2: 基础设施

#### 目标
搭建后续功能的基础依赖

#### 任务清单

```
├── Day 1-3: 区间算术
│   ├── 实现 Interval 类
│   ├── 实现区间四则运算
│   └── 实现三角函数区间运算
│
├── Day 4-7: 自动微分（仅移植，不集成）
│   ├── 移植 autodiff.h 核心代码
│   ├── 创建 AutoDiffTypes.hpp 封装
│   └── 编写单元测试验证
│
└── Day 8-10: 测试与文档
    ├── 编写单元测试
    └── 更新文档
```

#### 交付物

| 文件 | 说明 |
|------|------|
| `Math/Interval.hpp` | 区间算术类 |
| `AutoDiff/AutoDiff.hpp` | 自动微分核心 |
| `AutoDiff/AutoDiffTypes.hpp` | 类型封装 |
| 单元测试 | 测试通过 |

#### 验收标准

- [ ] Interval 类所有运算正确
- [ ] 自动微分梯度/Hessian 验证通过
- [ ] 单元测试覆盖率 > 80%

---

### 3.2 Week 3-4: BVH 加速结构

#### 目标
实现高效的碰撞检测加速

#### 任务清单

```
├── Day 1-3: AABB 包围盒
│   ├── 实现 AABB 类
│   ├── 实现包围盒运算（合并、相交等）
│   └── 编写单元测试
│
├── Day 4-7: BVH 结构
│   ├── 实现 BVH 节点结构
│   ├── 实现 BVH 构建（SAH策略）
│   └── 实现重叠查询
│
├── Day 8-10: 集成
│   ├── 实现 BVHBroadPhase 类
│   ├── 集成到现有 BroadPhase 接口
│   └── 性能基准测试
```

#### 交付物

| 文件 | 说明 |
|------|------|
| `Physics/Geometry/AABB.hpp` | 包围盒类 |
| `Physics/Geometry/BVH.hpp` | BVH结构 |
| `Physics/Contact/BVHBroadPhase.hpp` | 宽相位实现 |
| 性能测试报告 | 对比数据 |

#### 验收标准

- [ ] AABB 运算正确
- [ ] BVH 构建正确
- [ ] 查询性能优于暴力检测 10x

---

### 3.3 Week 5-6: CCD 核心实现

#### 目标
实现连续碰撞检测

#### 任务清单

```
├── Day 1-4: 基础CCD
│   ├── 实现点-三角形 CCD
│   ├── 实现边-边 CCD
│   └── 使用区间算术保证保守性
│
├── Day 5-7: CCD 系统
│   ├── 实现 CCDSystem 类
│   ├── 实现 TimeOfImpactCalculator
│   └── 集成 BVH 加速
│
├── Day 8-10: 集成到求解器
│   ├── 修改 IPCSolver 线搜索
│   ├── 实现 TOI 限制步长
│   └── 测试无穿透保证
```

#### 交付物

| 文件 | 说明 |
|------|------|
| `Physics/Contact/CCD/CCD.hpp` | CCD主接口 |
| `Physics/Contact/CCD/TimeOfImpact.hpp` | 碰撞时间计算 |
| `Physics/Contact/CCD/Interval.hpp` | 区间算术支持 |
| 无穿透测试 | 测试通过 |

#### 验收标准

- [ ] 点-三角形 CCD 正确
- [ ] 边-边 CCD 正确
- [ ] 快速运动场景无穿透

---

### 3.4 Week 7-8: 自适应障碍刚度

#### 目标
实现自适应刚度调整

#### 任务清单

```
├── Day 1-3: AdaptiveBarrier 类
│   ├── 实现障碍函数计算
│   ├── 实现刚度更新策略
│   └── 编写单元测试
│
├── Day 4-6: BarrierForm 扩展
│   ├── 实现最小距离计算
│   ├── 集成自适应刚度
│   └── 实现接触对管理
│
├── Day 7-10: 集成与测试
│   ├── 集成到 IPCSolver
│   ├── 参数调优
│   └── 稳定性测试
```

#### 交付物

| 文件 | 说明 |
|------|------|
| `Physics/Contact/AdaptiveBarrier.hpp` | 自适应障碍类 |
| `Dynamics/Forms/BarrierForm.hpp` | 扩展版本 |
| 稳定性测试 | 测试通过 |

#### 验收标准

- [ ] 刚度更新策略正确
- [ ] 最小距离计算准确
- [ ] 堆叠场景稳定收敛

---

### 3.5 Week 9-10: 摩擦势能模型

#### 目标
实现真实摩擦力模拟

#### 任务清单

```
├── Day 1-3: FrictionPotential 类
│   ├── 实现摩擦势能函数
│   ├── 实现梯度/Hessian 计算
│   └── 编写单元测试
│
├── Day 4-6: FrictionForm 类
│   ├── 实现 Form 接口
│   ├── 实现法向力更新
│   └── 实现接触点管理
│
├── Day 7-10: 集成与测试
│   ├── 集成到 IPCSolver
│   ├── 斜面滑块测试
│   └── 参数调优
```

#### 交付物

| 文件 | 说明 |
|------|------|
| `Physics/Contact/Friction.hpp` | 摩擦势能函数 |
| `Physics/Contact/FrictionCone.hpp` | 摩擦锥近似 |
| `Dynamics/Forms/FrictionForm.hpp` | 摩擦Form |
| 摩擦测试 | 测试通过 |

#### 验收标准

- [ ] 摩擦势能计算正确
- [ ] 梯度/Hessian 正确
- [ ] 斜面滑块摩擦力正确

---

### 3.6 Week 11-12: 集成测试

#### 目标
全面测试和优化

#### 任务清单

```
├── Day 1-4: 端到端测试
│   ├── 球体自由落体
│   ├── 双摆碰撞
│   ├── 堆叠物体
│   └── 多物体碰撞
│
├── Day 5-7: 性能优化
│   ├── 热点分析
│   ├── 内存优化
│   └── 并行化
│
├── Day 8-10: 文档完善
│   ├── API 文档
│   ├── 使用示例
│   └── 性能报告
```

#### 交付物

| 文件 | 说明 |
|------|------|
| 完整测试套件 | 所有测试 |
| 性能报告 | 基准数据 |
| API 文档 | 接口说明 |
| 使用示例 | 示例代码 |

#### 验收标准

- [ ] 所有测试场景通过
- [ ] 性能满足要求
- [ ] 文档完整

---

## 4. 测试场景规划

### 4.1 单元测试

| 模块 | 测试内容 |
|------|----------|
| Interval | 区间运算正确性、边界条件 |
| AutoDiff | 梯度/Hessian 正确性 |
| AABB | 包围盒运算、相交检测 |
| BVH | 构建、查询正确性 |
| CCD | TOI 计算正确性 |
| AdaptiveBarrier | 刚度更新、障碍函数 |
| Friction | 势能计算、梯度/Hessian |

### 4.2 集成测试场景

| 场景 | 验证目标 | 预期结果 |
|------|----------|----------|
| 球体自由落体 | 无穿透、能量守恒 | 无穿透，能量误差 < 1% |
| 双摆碰撞 | CCD 正确性、关节约束 | 关节约束满足，无穿透 |
| 堆叠物体 | 自适应刚度稳定性、BVH 性能 | 稳定收敛，性能提升 |
| 快速旋转物体 | CCD 正确性 | 无穿透 |
| 斜面滑块 | 摩擦力正确性 | 摩擦力符合理论值 |
| 多物体碰撞 | BVH 加速效果 | 性能提升 > 10x |

---

## 5. 风险管理

### 5.1 风险识别

| 风险 | 可能性 | 影响 | 风险等级 |
|------|--------|------|----------|
| CCD 数值精度问题 | 中 | 高 | 高 |
| 自适应刚度震荡 | 中 | 中 | 中 |
| BVH 构建开销 | 低 | 中 | 低 |
| 摩擦数值不稳定 | 中 | 中 | 中 |
| 与现有代码冲突 | 低 | 高 | 中 |
| 进度延期 | 中 | 中 | 中 |

### 5.2 应对措施

| 风险 | 应对措施 |
|------|----------|
| CCD 数值精度问题 | 增加安全边界，使用高精度算术，保守估计 |
| 自适应刚度震荡 | 添加平滑机制，限制变化率，参数调优 |
| BVH 构建开销 | 使用增量更新，延迟重建，并行构建 |
| 摩擦数值不稳定 | 正则化参数调优，使用稳定的摩擦模型 |
| 与现有代码冲突 | 完善单元测试，渐进集成，代码审查 |
| 进度延期 | 预留缓冲时间，并行开发，优先级调整 |

---

## 6. 资源需求

### 6.1 开发资源

| 阶段 | 人力投入 | 时间 |
|------|----------|------|
| 基础设施 | 1人 | 2周 |
| BVH 加速 | 1人 | 2周 |
| CCD 核心 | 1-2人 | 2周 |
| 自适应刚度 | 1人 | 2周 |
| 摩擦势能 | 1人 | 2周 |
| 集成测试 | 1-2人 | 2周 |

### 6.2 技术依赖

| 依赖 | 用途 | 状态 |
|------|------|------|
| Eigen | 线性代数 | 已有 |
| C++17 | 语言标准 | 已有 |
| CMake | 构建系统 | 已有 |
| Catch2 | 单元测试 | 已有 |

---

## 7. 附录

### 7.1 文件结构规划

```
include/NexDynIPC/
├── AutoDiff/
│   ├── AutoDiff.hpp
│   └── AutoDiffTypes.hpp
├── Math/
│   └── Interval.hpp
├── Physics/
│   ├── Geometry/
│   │   ├── AABB.hpp
│   │   └── BVH.hpp
│   └── Contact/
│       ├── AdaptiveBarrier.hpp
│       ├── Friction.hpp
│       ├── FrictionCone.hpp
│       └── CCD/
│           ├── CCD.hpp
│           ├── TimeOfImpact.hpp
│           └── Interval.hpp
└── Dynamics/
    └── Forms/
        ├── BarrierForm.hpp
        └── FrictionForm.hpp
```

### 7.2 参考文档

- [功能融合计划.md](file:///e:/workspace/NexDynIPC/documents/2026.02.12/功能融合计划.md)
- [刚体动力学模块对比分析.md](file:///e:/workspace/NexDynIPC/documents/2026.02.12/刚体动力学模块对比分析.md)
- [Rigid_IPC_理论文档.md](file:///e:/workspace/NexDynIPC/documents/2026.02.12/Rigid_IPC_理论文档.md)

---

*文档版本：1.0*  
*生成日期：2026-02-12*
